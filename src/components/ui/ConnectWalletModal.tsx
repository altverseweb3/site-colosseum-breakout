"use client";

import { useState, useEffect } from "react";
import Image from "next/image";
import { Wallet } from "lucide-react";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/StyledDialog";
import { Button } from "@/components/ui/Button";
import { toast } from "sonner";
import { WalletInfo, WalletType } from "@/types/web3";
import { cn } from "@/lib/utils";
import { useAppKit } from "@reown/appkit/react";
import { useWalletConnection } from "@/utils/walletMethods";
import useWeb3Store from "@/store/web3Store";

type WalletOption = {
  id: WalletType;
  name: string;
  icons: string[];
  disabled: boolean;
  background: string;
  connectMethod: () => Promise<WalletInfo | null>;
};

export const ConnectWalletModal = ({
  trigger,
  onSuccess,
}: {
  trigger?: React.ReactNode;
  onSuccess?: () => void;
}) => {
  const [modalOpen, setModalOpen] = useState(false);
  const [connecting, setConnecting] = useState<WalletType | null>(null);

  const { open } = useAppKit();

  const { isConnected } = useWalletConnection();
  const activeWallet = useWeb3Store((state) => state.activeWallet);

  // Close the modal and trigger onSuccess when wallet connects
  useEffect(() => {
    if (isConnected && activeWallet && modalOpen) {
      setModalOpen(false);
      toast.success(`Connected to ${activeWallet.name}`);
      if (onSuccess) onSuccess();
    }
  }, [isConnected, activeWallet, modalOpen, onSuccess]);

  const walletOptions: WalletOption[] = [
    {
      id: WalletType.REOWN_EVM,
      name: "evm wallets",
      icons: ["/wallets/metamask.svg", "/wallets/walletconnect.svg"],
      disabled: false,
      background: "bg-[#E27625]/0",
      connectMethod: async () => {
        open({ view: "Connect", namespace: "eip155" });
        return null;
      },
    },
    {
      id: WalletType.REOWN_SOL,
      name: "solana wallets",
      icons: ["/wallets/phantom.svg"],
      disabled: false,
      background: "bg-[#E27625]/0",
      connectMethod: async () => {
        open({ view: "Connect", namespace: "solana" });
        // Return null because the actual connection happens asynchronously
        return null;
      },
    },
    {
      id: WalletType.SUI,
      name: "sui",
      icons: ["/wallets/sui.svg"],
      disabled: false,
      background: "bg-[#4DA2FF]/0",
      connectMethod: async () => null,
    },
  ];

  const handleWalletSelect = async (wallet: WalletOption) => {
    if (wallet.disabled) {
      toast.info(`${wallet.name} integration coming soon!`);
      return;
    }

    try {
      setConnecting(wallet.id);
      console.log(`Connecting to ${wallet.name}...`);

      await wallet.connectMethod();

      // Note: We don't close the modal or show success here
      // The useEffect will handle this when isConnected becomes true
    } catch (error) {
      console.error(`Error connecting to ${wallet.name}:`, error);
      toast.error(`Failed to connect to ${wallet.name}.`);
      setConnecting(null);
    }
  };

  return (
    <Dialog open={modalOpen} onOpenChange={setModalOpen}>
      {trigger ? (
        <DialogTrigger asChild>{trigger}</DialogTrigger>
      ) : (
        <DialogTrigger className="flex items-center gap-2 px-4 py-2 rounded-md border border-amber-600 bg-gradient-to-r from-amber-500/10 to-amber-500/5 text-amber-500 hover:from-amber-500/20 hover:to-amber-500/10 transition-colors">
          <Wallet className="h-4 w-4" />
          <span>Connect Wallet</span>
        </DialogTrigger>
      )}
      <DialogContent
        className="sm:w-1/2 w-2/3 rounded-lg bg-[#18181B] border-[#27272A] border 
  [&>button]:!focus:ring-0 [&>button]:!focus:ring-offset-0 [&>button]:!focus:outline-none
  [&_svg.lucide-x]:text-amber-500 [&_svg.lucide-x]:w-[1.5rem] [&_svg.lucide-x]:h-[1.5rem] 
  [&_svg.lucide-x]:bg-[#442E0B] [&_svg.lucide-x]:rounded-[3px] 
  [&_svg.lucide-x]:border-[#61410B] [&_svg.lucide-x]:border-[0.5px]"
      >
        {" "}
        <DialogHeader>
          <DialogTitle className="text-[#FAFAFA]">select wallet</DialogTitle>
        </DialogHeader>
        <div className="mt-4 space-y-3">
          {walletOptions.map((wallet) => (
            <Button
              key={wallet.id}
              variant="outline"
              className={cn(
                "w-full flex items-center justify-between px-3 py-6 rounded-md bg-[#18181B] border border-[#27272A] transition-colors",
                wallet.disabled
                  ? "text-[#52525b]"
                  : "text-[#FAFAFA] hover:bg-[#27272A]",
              )}
              onClick={() => handleWalletSelect(wallet)}
              disabled={wallet.disabled || connecting !== null}
            >
              <div className="flex items-center">
                <span className="font-medium">{wallet.name}</span>
                {connecting === wallet.id && (
                  <span className="ml-3 text-xs text-amber-500">
                    connecting...
                  </span>
                )}
              </div>

              <div
                className={`h-8 w-auto relative flex items-center justify-center rounded-md ${
                  wallet.background
                }`}
              >
                <div className="flex items-center">
                  {wallet.icons.map((icon, index) => (
                    <Image
                      key={index}
                      src={icon}
                      alt={`${wallet.name} icon ${index + 1}`}
                      width={24}
                      height={24}
                      className="object-contain mx-1"
                    />
                  ))}
                </div>
              </div>
            </Button>
          ))}
        </div>
      </DialogContent>
    </Dialog>
  );
};

export default ConnectWalletModal;
